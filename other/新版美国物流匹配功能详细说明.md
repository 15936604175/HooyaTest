# 新版美国物流匹配功能详细说明

## 1. 功能概述

新版美国物流匹配功能（MatchLogisticsByUSV3）是一个复杂的物流匹配系统，用于根据订单信息、商品信息、仓库信息和各种业务规则，为美国境内及跨境（加拿大、墨西哥）订单匹配最佳的物流方式和发货仓库。

## 2. 核心流程

整个物流匹配流程可以分为以下几个主要阶段：

1. **基础信息验证**：确认订单基本信息，包括州名标准化、邮编有效性检查等
2. **规则校验**：包括黑名单校验、卡车单判断、特殊商品处理等
3. **指定物流处理**：处理预定义的物流方式和仓库
4. **邮编校验**：验证邮编有效性和偏远地区限制
5. **重量尺寸初始化**：计算包裹重量、尺寸和体积重量
6. **仓库匹配**：根据邮编、库存等因素匹配最佳仓库
7. **分配逻辑**：根据仓库优先级和库存情况分配最终发货仓库

## 3. 详细功能模块

### 3.1 基础信息验证

**功能说明**：对订单的基础信息进行验证和标准化处理，确保后续匹配流程的准确性。

**关键逻辑**：

- 州名标准化：将完整州名转换为标准缩写（如"California" → "CA"）
- 邮编有效性检查：通过缓存的邮编数据验证邮编是否有效
- 禁发州检查：检查订单是否发往禁发州（如HI、PR、AK、AS、GU、MP、VI等）
- 第三方仓库判断：根据MatchModel的name判断是否为第三方仓库

### 3.2 黑名单校验

**功能说明**：检查订单是否符合各种黑名单规则，包括地域黑名单、用户黑名单、商品黑名单等。

**关键逻辑**：

- 地址黑名单：检查订单地址是否在黑名单中
- 用户黑名单：检查客户ID、邮箱等是否在黑名单中
- 商品黑名单：
  - 美国禁售罗马伞货号
  - 加州禁售商品（如空气净化器）
  - 加拿大禁售商品
  - 婴儿车禁售规则
- 退单率高地址检查

### 3.3 卡车单判断

**功能说明**：判断订单是否包含需要卡车运输的商品，这类订单需要手动处理。

**关键逻辑**：

- 从匹配规则中查找类型为Transportation的规则
- 检查订单商品是否包含卡车单商品
- 如果包含卡车单商品，返回手动处理提示

### 3.4 CanCAToUS校验

**功能说明**：处理加拿大仓库发往美国的特殊规则和限制。

**关键逻辑**：

- 检查是否允许从加拿大仓库发往美国
- 检查订单商品是否包含禁止从加拿大发往美国的商品
- 检查是否需要只使用UPS物流

### 3.5 分体式空调处理

**功能说明**：对分体式空调订单进行特殊处理，包括配件检查和包装要求。

**关键逻辑**：
- 检查订单是否包含空调配件
- 验证配件是否完整
- 检查是否需要使用特定的空白纸箱
- 判断是否需要拆单处理

**流程图**：

```
开始
  └─→ 检查订单是否包含空调配件
        ├─→ 是
        │   ├─→ 验证配件完整性
        │   ├─→ 检查空白纸箱可用性
        │   └─→ 判断是否需要拆单
        └─→ 否
              └─→ 结束
```

### 3.6 指定物流处理

**功能说明**：处理预定义的物流方式和仓库，包括平台指定物流、店铺指定物流等。

**关键逻辑**：

- 从scb_order_carrier表中查询订单的指定物流信息
- 处理wayfair平台的特殊规则（重发/补发订单处理）
- 处理Vendor CA订单的特殊要求
- 处理特殊店铺的物流指定（如Only_UPSGround_Send规则）
- 处理仓库物流禁用UPS和FedEx互换规则

**流程图**：
```
开始
  └─→ 查询订单指定物流信息
        ├─→ 存在指定物流
        │   ├─→ 处理wayfair平台规则
        │   ├─→ 处理Vendor CA订单
        │   └─→ 处理特殊店铺物流指定
        └─→ 不存在指定物流
              └─→ 应用默认物流规则
                    └─→ 结束
```

### 3.7 邮编校验+偏远邮编校验

**功能说明**：验证邮编有效性和偏远地区限制，确保订单可以正常匹配。

**关键逻辑**：
- 检查邮编是否在缓存的邮编数据中
- 检查是否发往禁发州（AK、HI、PR）
- 检查是否为PO Box地址（部分店铺禁止发PO Box）

### 3.8 重量尺寸初始化

**功能说明**：计算包裹的重量、尺寸和体积重量，为后续物流匹配提供数据支持。

**关键逻辑**：

- 计算实际重量和体积重量
- 检查尺寸限制（最长边、周长等）
- 检查重量限制
- 处理分体式空调的特殊包装尺寸

**计算公式**：
- 体积重量（美国）：`weight_vol = volNum2 / 250`
- 体积重量（加拿大）：`weight_vol_ca = volNum2 / 225`
- 计费重量：`weight_phy = max(weight_vol, weight)`

### 3.9 指定仓库openbox处理

**功能说明**：处理需要从特定仓库发货的openbox订单。

**关键逻辑**：

- 检查订单是否标记为openbox
- 如果是openbox订单，指定特定仓库（US95）

### 3.10 仓库匹配

**功能说明**：根据订单邮编、库存情况和各种业务规则，匹配最佳的发货仓库。

**关键逻辑**：

- 根据邮编匹配仓库：使用缓存的邮编-仓库映射数据，按配送区域（GNDZone）和配送天数（TNTDAYS）排序
- 国际件处理：
  - 美国→加拿大/墨西哥订单使用UPSInternational物流
  - 加拿大订单优先使用虚拟仓（US116、US21、US121）
  - 墨西哥订单排除部分仓库（US121、US21）
- 仓库优先级设置：
  - 核心跨境仓库（US121、US21等）设置最高优先级
  - CA_Fedex仓库设置次高优先级
  - 常规仓库按默认优先级排序

**流程图**：
```
开始
  └─→ 筛选可用仓库
        ├─→ 国际件处理
        │   ├─→ 美国→加拿大订单
        │   │   ├─→ 优先虚拟仓
        │   │   └─→ 次选中转仓
        │   └─→ 美国→墨西哥订单
        │       └─→ 排除特定仓库
        └─→ 美国境内订单
              └─→ 根据邮编匹配仓库
                    ├─→ 按GNDZone排序
                    └─→ 按TNTDAYS排序
                          └─→ 结束
```

### 3.11 分配逻辑

**功能说明**：根据仓库优先级和库存情况，最终确定发货仓库。

**关键逻辑**：

- 查询美国restock仓库信息
- 遍历订单商品，检查可用库存
- 筛选仓库：排除特定仓库（如US07、FBA仓库）
- 处理平台指定仓库发货规则
- 禁发restock仓库处理

## 4. 定制化需求

### 4.1 特殊商品处理

**Air Purifier加州禁售**：
- 规则：overstock北美店铺空气净化器的订单地址是加州时，需要拦截
- 实现：从匹配规则列表中查找Ban_Overstock_CA_AirPurifier规则，检查当前订单是否包含禁售的空气净化器

**罗马伞美国禁售**：

- 规则：特定罗马伞货号在美国境内禁止销售
- 实现：检查订单商品是否包含禁售的罗马伞货号

**婴儿车禁售**：
- 规则：部分婴儿车货号在全美或加拿大禁止销售
- 实现：根据BabyCarNeedCancel和BabyCarNeedCancelCA规则检查禁售婴儿车

### 4.2 特殊平台处理

**Wayfair平台**：
- 规则：
  - wayfair平台补发重发订单需要指定仓库
  - 特定wayfair店铺（wayfair-topbuy,wayfair-gymax,wayfairgw）需要人为干涉确认指定仓发货
- 实现：检查订单是否为wayfair平台订单，根据订单类型和店铺应用不同规则

**Vendor CA订单**：
- 规则：
  - vendor CA订单不支持多包发货
  - 优先发虚拟仓库（US116，US21，US121）
  - 特定店铺只发-w店铺
- 实现：对Vendor CA订单单独处理，检查订单数量，优先选择虚拟仓

**WalmartVendor和wayfair**：
- 规则：从所有可用仓库的物流服务列表中移除ID为24的物流服务
- 实现：在仓库物流列表中移除指定物流服务

### 4.3 特殊物流规则

**Only_UPSGround_Send**：
- 规则：特定店铺只允许使用UPSGround物流
- 实现：检查店铺是否在Only_UPSGround_Send规则中，若是则设置OnlyUPS标志

**仓库物流禁用UPS和FedEx互换**：
- 规则：特定情况下禁止UPS和FedEx互换
- 实现：检查Ban_Fedex_ConvertUPSGround规则，根据当前物流方式调整可用物流列表

### 4.4 特殊仓库处理

**Costway-Jandy店铺**：

- 规则：只能发US07和US11仓库
- 实现：筛选可用仓库列表，只保留US07和US11

**西部仓库特殊处理**：
- 规则：如果第一个仓库是西部仓库且可用仓库中包含US98仓库，则提高US98仓库的优先级
- 实现：调整仓库排序，将US98仓库的优先级设为-50

## 5. 技术实现要点

1. **缓存机制**：使用缓存的邮编数据（_cacheZip）提高匹配效率
2. **规则引擎**：基于scb_WMS_MatchRule和scb_WMS_MatchRule_Details表实现灵活的规则配置
3. **库存检查**：实时查询仓库库存，考虑预占用库存和未发货订单
4. **优先级排序**：通过Sort字段实现仓库和物流的优先级管理
5. **错误处理**：详细的错误信息返回，便于运营人员处理异常订单

## 6. 总结

新版美国物流匹配功能是一个高度复杂和灵活的系统，通过整合多种业务规则和数据来源，实现了高效、准确的物流匹配。该功能支持多种定制化需求，能够适应不断变化的业务场景和规则调整。

通过合理的流程设计和规则配置，该系统能够：
- 提高物流匹配的准确性和效率
- 降低物流成本
- 提高客户满意度
- 减少人工干预
- 支持多种特殊业务场景

未来可以考虑进一步优化的方向：
1. 引入机器学习算法，基于历史数据优化仓库和物流匹配
2. 增强规则配置的可视化界面，便于运营人员调整规则
3. 加强异常情况的自动处理能力，减少人工干预
4. 优化缓存机制，进一步提高匹配效率